---
title: "Project Report: Cars Crash"
author: "Huy Ngo"
date: "Fall 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(digits = 3)
```

```{r load-sas-libraries, echo = F, message = F, warning = F}

library(SASmarkdown)
sas_enginesetup(sashtml=sashtml)

sasexe <- "C:/Program Files/SASHome/SASFoundation/9.4/sas.exe"
sasopts <- "-nosplash -ls 75"

# Linux options (for grading, please leave this in!)
# sasexe <- "/usr/local/SASHome/SASFoundation/9.4/bin/sas_en"
# sasopts <- "-ls 75"
```

```{r, echo=FALSE, message=FALSE, warning=FALSE} 
library(dplyr)
library(readr)
library(ggplot2)
library(plotly)
Crash <- read_csv("monroe-county-crash-data2003-to-2015.csv")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(lubridate)
library(dplyr)
library(stringr)
library(plotly)
tmp <- Crash %>%
  mutate(hm = sprintf("%04d", Hour),
         hour = str_sub(hm, 1, 2) %>% parse_number(),
         minute = str_sub(hm, 3, 4) %>% parse_number()) %>%
  mutate(wday = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")[Day],
         wday_dec = Day + hour/24)
```

## Introduction
* Automobiles are an indispensable part of life. Thanks to them that travel, transaction, business, and even medical problems has been improving. But they also carry risks that affect human life. People's need is higher and higher, so the number of vehicles must also increase, which entails many consequences such as traffic congestion and accidents. Every day, with hundreds of millions of car trips moving continuously across the country, the chance that one person might find him/herself get involved in an accident is not small.

* The data use in this project is accidents recorded in Monroe County, Indiana, from 2003 to 2015. There are more than 53.000 observations (cases reported) and many variables,like:
  - Day/ Month/ Year/ Hour (that accidents occurred). 
  - Collision type: How many cars involved?  
  - What kind of injuries? 
  - What is the primary reason that causes accidents to happen?
  - Location: longitude and latitude.


```{r, engine="sashtml", engine.path=sasexe, engine.opts=sasopts, collectcode = T, error = T, echo=FALSE, message=FALSE, warning=FALSE}
ODS HTML STYLE=HTMLBLUE;
filename dat "monroe-county-crash-data2003-to-2015.csv";
PROC IMPORT DATAFILE = dat OUT = Crash
    DBMS = CSV 
    REPLACE; 
    GETNAMES = YES;
    GUESSINGROWS = 5000;
RUN;
proc print data= Crash (obs=5);
var Year Month Day Hour Collision_Type Injury_Type Primary_Factor;
title 'Table.1. Accidents Reported from 2003 to 2015 in Monroe County, Indiana';
run;
```

* Some questions I want to find out through the data:
  - Which year has the highest rate of accident? On what month? Is that month consistent for all other years? 
  - Is there any specific day (or month, year) with more accidents than the other day (month/ year)? 
  - On that day (month/ year), what is the primary factor that causes the accident? What are the highest injuries? 
  - What can we conclude about driving habit of citizen of Monroe county?
  
## Methods

* Comparing the overall with a specific year to find the "trend" of accidents.
* Find the year that has the most accidents occurred. Call it Result. 1
* Among the years, find the month that has the highest accidents. Call it Result. 2
  - Look at the year found in Result. 1, then, find the month has the most accidents. Call it Result. 3. 
  - Compare Result. 3 with Result. 2. 
* Among the years, look at the day with most accidents, identify if it weekday or weekend. Call it Result. 4
  - Look at the Result. 1 and find which type of day has more accidents. Call it Result. 5. 
  - Compare Result. 5 and Result. 4. 
* Among the years, find the hour (in a 24-hour format) with the highest accidents. Call it Result. 6
  - Look at Result. 1 and find which hour has the most accidents. Call it Result. 7
  - Compare Result. 6 and Result. 7. 
* Among the years, look for the primary factor that causes accidents. Call it Result. 8
  - Look at Result. 1 and find the primary factor for accidents. Call it Result. 9
  - Compare Result. 8 and Result. 9. 
* Look at the relationship between all the factors above. Conclude.


## Results

- The frequency table below shows us that 2003 was the year with the most accidents: 4625 cases.From now on, we will compare the overall years vs the year 2003.

```{r, error = T, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
Count<-table(tmp$Year)
Count
tmp %>%
  group_by(Year) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  ggplot(aes(x = Year, y = count)) + 
  geom_bar(stat="identity", fill="steelblue") + 
  geom_text(aes(label=count), vjust=1.6, color="white", size=3.5)+
  ggtitle("Figure 1. Overall cases, year by year") +
  theme_minimal()
  

```

- We look at the overall years and found that the month with the most accidents is October. (Figure. 2)

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(plotly)
p <- tmp %>%
  group_by(Month, Year) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  ggplot(aes(x = Month, y = count)) + 
  geom_line(aes(frame = Year))+
  ggtitle("Figure 2. Overall cases, month by month") 
ggplotly(p)

```

- Consider the year 2003 only, we find that October is still the month with most accidents (477 cases - Figure. 3). The data looks consistent.

```{r, echo=FALSE, message=FALSE, warning=FALSE}

Month<-filter(tmp, Year == "2003")
ggplot(Month, aes(x = Month)) + 
  geom_line(stat = "count", aes(y = ..count..))+
  geom_text(aes(Month, 600, label=Month))+
  ggtitle("Figure 3. Cases in 2003, month by month") +
  theme_minimal()
```

- Figure 4. shows that Friday is the day with most accidents happened through overall years.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(plotly)

p <- tmp %>%
  group_by(wday, Year) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  ggplot(aes(x = wday, y = count)) + 
  geom_point(aes(frame = Year))+
  ggtitle("Figure 4. Overall cases, day by day")
ggplotly(p)
```

- Consider 2003, we found that Friday is still the day with the most cases. The data looks consistent for now. 

```{r, echo=FALSE, message=FALSE, warning=FALSE}

ggplot(Month, aes(x = wday)) + 
  geom_point(stat = "count", aes(y = ..count..))+
  ggtitle("Fig. 5. Cases in 2003, day by day") 
```







```{r, echo=FALSE, message=FALSE, warning=FALSE, figures-side, fig.show="hold", out.width="50%"}
ggplot(tmp, aes(x = hour)) + 
  geom_bar(fill="orange")+
  ggtitle("Figure 6. Overall cases, hour by hour") +
  theme_minimal()

ggplot(Month, aes(x = hour)) + 
  geom_bar(fill="darkgreen")+
  ggtitle("Figure 7. Cases in 2003, hour by hour") +
  theme_minimal()

```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(plotly)

p <- tmp %>%
  group_by(hour, `Weekend?`, Year) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  ggplot(aes(x = hour, y = count, color = `Weekend?`)) + 
  geom_line(aes(frame = Year))+
  ggtitle("Figure 10. Accidents relate in hour and weekend overall years")
ggplotly(p)
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(tmp, aes(x = "", fill=`Injury Type`)) + 
  geom_bar()+
  ggtitle("Figure 11. Injury types  overall from 2003 to 2015") +
  theme_minimal()+
  coord_polar("y")
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(Month, aes(x = "", fill=`Injury Type`)) + 
  geom_bar()+
  ggtitle("Figure 12. Injury types  in from 2003") +
  theme_minimal()+
  coord_polar("y")
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
tmp %>%
  group_by(`Collision Type`, Month) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  ggplot(aes(x = Month, y = count)) + 
  geom_col() + 
  ggtitle("Figure 13. Collision types from 2003 to 2015") +
  facet_wrap(~`Collision Type`)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}
tmp %>%
  filter(Year == "2003") %>%
  group_by(`Collision Type`, Month) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  ggplot(aes(x = Month, y = count)) + 
  geom_col() + 
  ggtitle("Figure 14. Collision types in 2003") +
  facet_wrap(~`Collision Type`)

```



- For the overall years, the primary factor that for most of the accidents is "Failure to yield right of way".
```{r, fig.height=20, fig.width=15, echo=FALSE, message=FALSE, warning=FALSE}
library(forcats)
ggplot(tmp, aes(x = fct_rev(fct_infreq(`Primary Factor`)))) + 
  geom_bar()+
  ggtitle("Figure 15. Primary factors for accidents from 2003 to 2015") +
  theme_minimal()+ coord_flip()
```

- For the year of 2003, "Failure to yield right of way" is still the most factor that lead to accidents. 
```{r, fig.height=20, fig.width=15, echo=FALSE, message=FALSE, warning=FALSE}
library(forcats)
ggplot(Month, aes(x = fct_rev(fct_infreq(`Primary Factor`)))) + 
  geom_bar()+
  ggtitle("Figure 16. Primary factors for accidents in 2003") +
  theme_minimal()+ coord_flip()
```




```{r}
ggplot(data = world) +
    geom_sf() +
    geom_point(data = Month, aes(x = Longitude, y = Latitude), size = 4, 
        shape = 23, fill = "darkred") +
    coord_sf(xlim = c(-88, -78), ylim = c(24.5, 33), expand = FALSE)

```


## Conclusion
